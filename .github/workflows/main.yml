name: MacRDP
on: 
  workflow_dispatch:
jobs:
  build:
    name: MacRDP
    runs-on: macos-latest
    
    steps:                 
    - name: Install and Connect Tailscale
      env:
        TAILSCALE_KEY: ${{ secrets.NGROK_AUTH_TOKEN }}
      run: |
        brew install tailscale
        # Correct way to start tailscaled on macOS runners
        sudo /opt/homebrew/bin/tailscaled > /dev/null 2>&1 &
        sleep 10
        sudo /opt/homebrew/bin/tailscale up --authkey "$TAILSCALE_KEY" --hostname="GitHub-Mac" --accept-routes
        
    - name: Enable MacOS Screen Sharing
      run: |
        # Using the standard kickstart command (works on Sequoia)
        # We skip the firewall proxy command that caused the error
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
        -activate -configure -access -on \
        -clientopts -setvncpassword -vncpassword "P@ssw0rd!" \
        -restart -agent -privs -all
          
    - name: MacOS System running...
      uses: mxschmitt/action-tmate@v3
      if: always()
